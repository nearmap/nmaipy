name: Release Validation

on:
  push:
    tags:
      - 'v*'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run tests
      run: pytest

    - name: Get version
      id: get_version
      run: |
        echo "VERSION=$(python -c 'from nmaipy import __version__; print(__version__)')" >> $GITHUB_OUTPUT

    - name: Verify tag matches version
      run: |
        TAG_VERSION=${GITHUB_REF#refs/tags/v}
        PACKAGE_VERSION=${{ steps.get_version.outputs.VERSION }}
        if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
          echo "Error: Tag version ($TAG_VERSION) doesn't match package version ($PACKAGE_VERSION)"
          exit 1
        fi

    - name: Build package
      run: python -m build

    - name: Upload artifacts to release
      uses: softprops/action-gh-release@v2
      with:
        files: dist/*
        fail_on_unmatched_files: true

    - name: Verify PyPI package
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        echo "Checking for nmaipy $VERSION on PyPI..."
        for i in 1 2 3; do
          echo "Attempt $i/3..."
          if pip index versions nmaipy 2>/dev/null | grep -q "$VERSION"; then
            echo "Found nmaipy $VERSION on PyPI"
            exit 0
          fi
          if [ $i -lt 3 ]; then
            echo "Not found yet, waiting 30 seconds..."
            sleep 30
          fi
        done
        echo "ERROR: nmaipy $VERSION not found on PyPI after 3 attempts"
        echo "Did you run /publish or manually upload to PyPI before pushing the tag?"
        exit 1
